namespace = stellar_evolution

# Architecture
## Each event chain occupies 1000 ids.
## Each step in the event chain occupy 100 ids.
## Each group of events occupy 10 ids.

# Flags Remarks
## stellar_evolution_happened: A star can only evolve once in a game, because realistically the time interval between stellar evolution events is too long.

# Begin Events section

# Evolution for B-class and A-class stars
planet_event = {
	id = stellar_evolution.1
	hide_window = yes

	trigger = {
		AND = {
			OR = {
				is_planet_class = pc_b_star
				is_planet_class = pc_a_star
			}
			NOT = { has_planet_flag = stellar_evolution_happened }
		}
	}
	mean_time_to_happen = { years = 500 }

	immediate = {
		set_planet_flag = stellar_evolution_happened
		planet_event = { id = stellar_evolution.11 }
	}
}

# Evolution for F-class stars
planet_event = {
	id = stellar_evolution.2
	hide_window = yes

	trigger = {
		AND = {
			is_planet_class = pc_f_star
			NOT = { has_planet_flag = stellar_evolution_happened }
		}
	}
	mean_time_to_happen = { years = 1000 }

	immediate = {
		set_planet_flag = stellar_evolution_happened
		planet_event = { id = stellar_evolution.11 }
	}
}

# Evolution for G-class stars
planet_event = {
	id = stellar_evolution.3
	hide_window = yes

	trigger = {
		AND = {
			is_planet_class = pc_g_star
			NOT = { has_planet_flag = stellar_evolution_happened }
		}
	}
	mean_time_to_happen = { years = 2000 }

	immediate = {
		set_planet_flag = stellar_evolution_happened
		planet_event = { id = stellar_evolution.11 }
	}
}

# To avoid code repetition, unify main sequence to giant evolution event here
planet_event = {
	id = stellar_evolution.11
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		set_planet_flag = stellar_evolution_giant

		add_modifier = { modifier = evolving_main_sequence }
		clear_deposits = yes
		add_deposit = d_physics_10

		if = {
			limit = { is_planet_class = pc_g_star }
			every_country = {
				limit = {
					is_ai = no
				}
				country_event = {
					id = stellar_evolution.21
				}
			}
		}
		else = {
			every_country = {
				limit = {
					is_ai = no
				}
				country_event = {
					id = stellar_evolution.22
				}
			}
		}

		# In 10 - 15 years, start the actual chain that evolves the star into a red giant.
		planet_event = {
			id = stellar_evolution.101
			days = 3600
			random = 1800
		}
	}
}

# Associated country events
country_event = {
	id = stellar_evolution.21

	title = stellar_evolution.21.name
	desc = stellar_evolution.21.desc
	picture = GFX_evt_star_yellow
	show_sound = event_solar_fusion
	location = from

	is_triggered_only = yes
}

country_event = {
	id = stellar_evolution.22

	# Reuse description - don't need to change anything other than the picture
	title = stellar_evolution.21.name
	desc = stellar_evolution.21.desc
	picture = GFX_evt_star_white
	show_sound = event_solar_fusion
	location = from

	is_triggered_only = yes
}

# Star gets closer to evolving
planet_event = {
	id = stellar_evolution.101
	hide_window = yes
	is_triggered_only = yes

	# Some mods alter the star's class.
	# As a failsafe, abort if the star no longer belongs to a class that can evolve.
	trigger = {
		OR = {
			is_planet_class = pc_b_star
			is_planet_class = pc_a_star
			is_planet_class = pc_f_star
			is_planet_class = pc_g_star
		}
	}

	immediate = {
		add_deposit = d_physics_10
		add_deposit = d_engineering_5

		while = {
			count = 5
			random_list = {
				10 = {}
				15 = {
					add_deposit = d_physics_10
				}
				15 = {
					add_deposit = d_engineering_5
				}
				10 = {
					add_deposit = d_physics_10
					add_deposit = d_engineering_5
				}
			}
		}

		if = {
			limit = { is_planet_class = pc_g_star }
			every_country = {
				limit = {
					is_ai = no
				}
				country_event = {
					id = stellar_evolution.111
				}
			}
		}
		else = {
			every_country = {
				limit = {
					is_ai = no
				}
				country_event = {
					id = stellar_evolution.112
				}
			}
		}
	}
}

# Associated country events
country_event = {
	id = stellar_evolution.111

	title = stellar_evolution.111.name
	desc = stellar_evolution.111.desc
	picture = GFX_evt_star_yellow
	show_sound = event_solar_fusion
	location = from

	is_triggered_only = yes
}

country_event = {
	id = stellar_evolution.112

	title = stellar_evolution.111.name
	desc = stellar_evolution.111.desc
	picture = GFX_evt_star_white
	show_sound = event_solar_fusion
	location = from

	is_triggered_only = yes
}
